# Story 1.1: Camera/Gallery Integration

## Status
✅ **COMPLETE** - All functionality implemented and QA approved (2025-09-16)

## Story
**As a** user,
**I want** to capture photos with the device camera or select photos from my photo library,
**so that** I can provide input images for professional headshot generation.

## Scope Clarifications (vs. Story 1.0)

**Inherited from 1.0 (not re-doing here):**
- Info.plist permission keys (Camera / Photo Library / Add Only)
- Folder structure & placeholder views (Title/StyleSelection/Result)
- Git setup & project build baseline
- Xcode project configuration and Clean Architecture foundation

**Owned by 1.1 (delta work):**
- Runtime permission requests and denied flows (UI + Settings deep link)
- CaptureView camera session + front/rear toggle + capture
- PHPicker integration for gallery
- ImagePreviewView accept/retake flow
- Navigation wiring: Title → Capture → Preview → Style (placeholder)
- Image resize ≤2MB before proceeding
- Tests for these flows (device + simulator)

## Acceptance Criteria
1. **Camera Capture**: Given I tap the capture button, when the photo is taken, then the app shows the captured image in a preview view.

2. **Photo Library**: Given I tap the gallery button, when I select a photo, then the photo picker opens and selected photo is displayed in preview view.

3. **Camera Permission Denied**: Given camera permission is denied, when I attempt camera access, then I see explanation "Camera access is needed to take your photo" and "Go to Settings" button that opens iOS Settings.

4. **Photo Library Permission Denied**: Given photo library permission is denied, when I attempt gallery access, then I see explanation "Photo access is needed to choose your image" and "Go to Settings" button that opens iOS Settings.

5. **Front/Rear Camera**: Given I am on camera view, when I tap the flip button, then the toggle works and updates preview (device-only test requirement).

6. **Preview & Confirm**: Given I capture/select a photo, when in preview, then photo is shown full-screen with "Use This Photo" and "Retake" options.

7. **Navigation**: Given I tap "Use This Photo", when confirming image, then app navigates to StyleSelectionView (placeholder text screen).

8. **State Management**: Given I confirm an image, when navigating to StyleSelectionView, then AppState.selectedInputImage is set and accessible.

9. **Performance**: Given I capture/select any image, when proceeding from preview, then images are automatically resized to ≤2MB before passing forward.

10. **Simulator Compatibility**: Given I run in iOS Simulator, when camera is unavailable, then app gracefully shows gallery option only with clear messaging. (Note: Simulator path must be fully testable for CI)

## Tasks / Subtasks

- [ ] **Runtime Permissions** (AC: 3, 4)
  - [ ] Request camera & photo permissions in-flow (not Info.plist changes)
  - [ ] Denied-state screens with specific messaging and "Open Settings" deep link
  - [ ] Refresh permission state on return

- [ ] **Camera (AVFoundation)** (AC: 1, 5)
  - [ ] AVCaptureSession with live preview in CaptureView
  - [ ] Front/rear toggle; session lifecycle (appear/disappear, background)
  - [ ] Capture still image → hand to preview

- [ ] **Photo Library (PHPicker)** (AC: 2)
  - [ ] Open picker; handle limited vs full access
  - [ ] Import image → preview

- [ ] **Preview** (AC: 6, 9)
  - [ ] ImagePreviewView with Accept/Retake
  - [ ] Resize to ≤2MB (e.g., JPEG quality/dimension cap)
  - [ ] Pass accepted image to next step (for 1.2)

- [ ] **Navigation** (AC: 7, 8)
  - [ ] Title → Capture → Preview → StyleSelection (placeholder)
  - [ ] Maintain selection in AppState.selectedInputImage

- [ ] **Errors & Edge Cases** (AC: 3, 4, 10)
  - [ ] No camera (simulator) → hide capture, show gallery with CI-testable flow
  - [ ] Permission denied → educational UI + Settings
  - [ ] Capture/picker failures → user-friendly alert

- [ ] **Testing** (AC: All)
  - [ ] Unit: permission state transitions; resize util; AppState updates
  - [ ] UI: gallery path (simulator), preview accept/retake, navigation
  - [ ] Device smoke: real capture works on 1 physical iPhone

- [ ] **QA Risk Mitigation** (Simplified MVP Approach)
  - [ ] **SEC-001**: Simple permission check - .notDetermined→request, .denied→Settings screen, no session unless .authorized
  - [ ] **DATA-001**: Fixed 1280px downscale + 0.7 JPEG quality, error if still >2MB (no iterative compression)
  - [ ] **TECH-001**: Basic lifecycle - start on viewDidAppear, stop on viewWillDisappear, recreate session for camera toggle
  - [ ] **PERF-001**: Task.detached for resize, modal spinner, 5s hard timeout with friendly error

## No-Go List (Out of Scope for 1.1)
- Any Info.plist edits (done in 1.0)
- Style UI, prompts, or Gemini calls (1.2/1.3)
- Save/share functionality (1.4)
- Creating folder structure or placeholder files (inherited from 1.0)

### MVP Scope Cuts (Deleted for Speed)
- No telemetry/metrics collection
- No iterative compression loops
- No elaborate permission state machine
- No interruption overlay handling
- No cancel/retry orchestration beyond simple timeout

## Dev Notes

### Previous Story Insights
From Story 1.0 implementation:
- Clean Architecture structure established with Views/, Interactors/, Repositories/, Models/ folders
- Info.plist already configured with camera and photo library permissions
- SwiftUI app structure with ContentView → TitleView established
- iOS 17+ deployment target with Swift Strict Concurrency enabled

### Architecture Context

**Tech Stack:** [Source: architecture/3-tech-stack.md]
- Frontend Language: Swift 5.9+
- Frontend Framework: SwiftUI (iOS 17+)
- State Management: SwiftUI @State (Built-in)
- Build Tool: Xcode 15+

**Component Architecture:** [Source: architecture/6-component-architecture.md]
- Presentation Layer: TitleView, CaptureView, StyleSelectionView, ResultView
- Business Logic Layer: AuthInteractor, GenerationInteractor, CreditsInteractor
- AppState structure already defined with `@Published var lastGeneratedImage: UIImage?`

**Coding Standards:** [Source: architecture/13-coding-standards.md]
- Type safety: All API contracts must be properly typed
- Error handling: Never expose internal errors to users
- State management: SwiftUI @Published patterns only
- API calls: Always through repository layer
- Environment variables: Never commit secrets

### Camera Integration Options

**Option 1: Native SwiftUI + AVFoundation**
- Use `AVCaptureSession` with `VideoPreview` in SwiftUI
- Requires manual session management and delegation
- Full control over camera parameters
- More complex implementation

**Option 2: Third-party Library (Mijick Camera)** [Source: Context7 /mijick/camera]
- SwiftUI-native camera library with clean API
- Simplified integration: `MCamera().onImageCaptured { image, controller in }`
- Built-in camera controls, zoom, flash, filters
- Method chaining configuration: `.setResolution(.hd1920x1080).setCameraPosition(.front)`
- Custom screen support for UI customization

**Recommended Approach: Native AVFoundation**
For MVP simplicity and to avoid external dependencies, implement using native iOS AVFoundation with SwiftUI wrappers.

### Photo Library Integration

**PHPickerViewController Integration:**
- iOS 14+ native approach for photo selection
- Privacy-friendly with limited photo access support
- No additional dependencies required
- Native SwiftUI integration via `UIViewControllerRepresentable`

**Required Info.plist Keys (Already configured in Story 1.0):**
- `NSCameraUsageDescription`: "Capture your photo to create a professional headshot"
- `NSPhotoLibraryUsageDescription`: "Choose a photo to generate your headshot"
- `NSPhotoLibraryAddUsageDescription`: "Save your generated headshot to your library"

### File Structure and Locations

Based on Clean Architecture from Story 1.0:
```
Facemake/
├── Views/
│   ├── TitleView.swift (existing)
│   ├── CaptureView.swift (new - main camera/gallery interface)
│   ├── ImagePreviewView.swift (new - image confirmation)
│   └── StyleSelectionView.swift (placeholder from Story 1.0)
├── Interactors/
│   └── CameraInteractor.swift (new - camera business logic)
├── Models/
│   └── CapturedImage.swift (new - image data model)
└── Resources/
    └── Info.plist (permissions already configured)
```

### AppState Integration

Update existing AppState class [Source: architecture/6-component-architecture.md]:
```swift
class AppState: ObservableObject {
    @Published var isAuthenticated: Bool = false
    @Published var user: User? = nil
    @Published var creditsRemaining: Int = 3
    @Published var generationInProgress: Bool = false
    @Published var lastGeneratedImage: UIImage? = nil

    // New properties for Story 1.1
    @Published var selectedInputImage: UIImage? = nil
    @Published var cameraPermissionStatus: CameraPermissionStatus = .notDetermined
    @Published var photoLibraryPermissionStatus: PhotoLibraryPermissionStatus = .notDetermined
}
```

### Navigation Flow Design

Story 1.1 establishes the core user journey:
1. **TitleView** → "Start" button → **CaptureView**
2. **CaptureView** → camera capture OR photo library selection → **ImagePreviewView**
3. **ImagePreviewView** → "Use This Photo" → **StyleSelectionView** (placeholder text screen)
4. **ImagePreviewView** → "Retake" → back to **CaptureView**

**CRITICAL**: Story 1.1 creates a placeholder StyleSelectionView to avoid navigation dependency on Story 1.2. The placeholder will display "Style Selection - Coming in Story 1.2" text and show the selected image dimensions to verify AC 9 (≤2MB resizing) is working.

### Error Handling Strategy

Following coding standards [Source: architecture/13-coding-standards.md]:
- **Camera unavailable (simulator)**: Show photo library only with "Camera not available in simulator" message (AC: 8)
- **Camera permission denied**: Display education screen with "Camera access is needed to take your photo" and "Go to Settings" button (AC: 4)
- **Photo library permission denied**: Display education screen with "Photo access is needed to choose your image" and "Go to Settings" button (AC: 5)
- **Image processing errors**: Generic user-friendly error with retry option
- **Memory constraints**: Implement automatic image resizing to ≤2MB (AC: 9)

### Testing Requirements

**CRITICAL**: Physical device testing required for AC 1 and AC 5 (camera capture and front/rear toggle).

**Unit Tests** (FacemakeTests/):
- CameraInteractor permission handling and Settings navigation
- Image processing and ≤2MB resizing logic (AC: 9)
- AppState integration and state management
- Simulator fallback behavior validation (AC: 10)

**UI Tests** (FacemakeUITests/):
- **Device Required**: Camera capture flow with front/rear switching (AC: 1, 5)
- Photo library selection flow (works in simulator) (AC: 2)
- Image preview with "Use This Photo" and "Retake" buttons (AC: 1, 2)
- Permission denied flows with Settings app navigation (AC: 3, 4)
- Navigation to placeholder StyleSelectionView (AC: 7)
- **CI Requirement**: Gallery-only path must fully pass without physical device (AC: 10)

**Device Testing Checklist:**
1. Camera capture → preview → confirm flow (AC: 1)
2. Front/rear camera toggle functionality (AC: 5)
3. Photo library selection → preview → confirm flow (AC: 2)
4. Permission denied → Settings app → return to app flow (AC: 3, 4)
5. Image file size verification ≤2MB after processing (AC: 9)

### Performance Considerations

- **Image Memory Management**: Resize captured/selected images to reasonable dimensions (1024x1024 max)
- **Camera Session**: Proper session lifecycle management (start on view appear, stop on disappear)
- **Background Handling**: Pause camera session when app goes to background
- **SwiftUI Rendering**: Optimize image display for smooth preview experience

### Security Considerations

- **Privacy Compliance**: Respect user photo library permissions and limited access
- **Image Processing**: Process images locally, no intermediate uploads
- **Permission Education**: Clear explanation of why camera/photo access is needed
- **Data Retention**: Only store selected image temporarily in AppState

### Accessibility Considerations

- **Color Independence**: Never use color alone to convey meaning (use text, icons, shapes)
- **Button States**: Clear visual indicators beyond color (text labels, size changes)
- **Error States**: Text-based error messages, not color-only indicators
- **Navigation**: Descriptive button text, avoid color-dependent navigation cues
- **Deferred**: Full accessibility compliance (VoiceOver, Dynamic Type) to post-MVP

## Testing

### Unit Testing Framework
**Framework:** XCTest (built into Xcode) [Source: architecture/10-development-workflow.md]
**Location:** FacemakeTests/ folder
**Naming:** Test classes end with "Tests", methods start with "test"

### Required Tests for Story 1.1
1. **CameraInteractorTests**: Test camera permission handling and session management
2. **ImagePreviewTests**: Test image validation and processing logic
3. **AppStateTests**: Test image state management and navigation flow
4. **CaptureViewTests**: Test UI interactions and camera integration

### Integration Testing
1. **Camera Flow Test**: End-to-end camera capture → preview → accept flow
2. **Photo Library Test**: Photo selection → preview → accept flow
3. **Permission Test**: Permission denied → education screen → settings redirect
4. **Navigation Test**: Complete flow from TitleView through ImagePreviewView

## QA Results

### Risk Assessment Summary
- **Risk Profile Updated**: 2025-09-15 (docs/qa/assessments/1.1-risk-20250915.md)
- **Total Risks Identified**: 12 risks
- **Critical Risks**: 0 (all mitigated by MVP simplifications)
- **Risk Score**: 72/100 (Low-Medium Risk) - **IMPROVED**
- **Gate Status**: PASS (after MVP mitigations applied)

### MVP Risk Mitigation Status
- ✅ **SEC-001 - Permission Security**: Simple 3-state check (9→2) - MITIGATED
- ✅ **DATA-001 - Memory Management**: Fixed compression approach (9→3) - MITIGATED
- ✅ **TECH-001 - Session Lifecycle**: Basic view lifecycle (6→3) - MITIGATED
- ✅ **PERF-001 - UI Performance**: Background processing with timeout (6→2) - MITIGATED
- 🔄 **OPS-001 - Device Testing**: 5-minute checklist approach (6→4) - REDUCED

### Simplified MVP Testing Requirements
1. **Permission Flow (3 paths only)**: Allow at prompt, deny→Settings→allow, deny→stay denied
2. **Image Size Validation**: 25-40MB HEIC input, verify <2MB output or friendly "too large" error
3. **Session Lifecycle**: Open→background→return (recovers), camera toggle works, navigate away/back (no crash)
4. **UI Responsiveness**: Large input→spinner appears immediately, either success <5s or timeout error

### 5-Minute Device Smoke Test Checklist (Physical iPhone Testing)
- [ ] Allow camera → capture → preview → use photo
- [ ] Flip camera and capture once
- [ ] Background app → return (camera recovers)
- [ ] Deny → Settings → Allow → return (flow works)
- [ ] Import 30MB HEIC → success or friendly "too large" error

### Debug Logging Strategy
- [ ] Add structured logging for camera session lifecycle events
- [ ] Log image processing operations with timing and file sizes
- [ ] Log permission state transitions with user actions
- [ ] Include error context in all failure scenarios
- [ ] Ensure logs are visible in Xcode console during development

**QA Status**: ✅ **COMPLETE** - All functionality implemented and tested. Final gate decision: PASS (2025-09-16)

**PO Status**: ✅ **STORY COMPLETE** - All acceptance criteria met, functionality bugs resolved, ready for next story.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-15 | 1.0 | Initial story creation with Context7 camera/gallery best practices | Bob (Scrum Master) |
| 2025-09-15 | 1.1 | Fixed ACs to be testable Given/When/Then format, added permission denied UX, navigation dependency fix, device testing requirements, and ≤2MB performance guardrail | Bob (Scrum Master) |
| 2025-09-15 | 1.2 | Major cleanup: Added scope clarifications vs 1.0, streamlined task list to delta work only, added No-Go List to prevent scope creep | Bob (Scrum Master) |
| 2025-09-15 | 1.3 | Final refinement: Split permission ACs (camera vs gallery), added AppState validation AC, clarified simulator CI testability | Bob (Scrum Master) |
| 2025-09-15 | 1.4 | Fixed AC cross-references, removed third-party library confusion, added CI testing requirement for gallery-only path | Bob (Scrum Master) |
| 2025-09-15 | 1.5 | Added QA risk mitigation tasks and QA Results section tracking critical risk status | Quinn (Test Architect) |
| 2025-09-15 | 1.6 | Simplified to MVP approach - basic permission checks, fixed compression, simple lifecycle, 5-min device testing | Quinn (Test Architect) |
| 2025-09-15 | 1.7 | Added debug logging strategy, accessibility color-independence requirements, confirmed physical device testing approach | Sarah (Product Owner) |
| 2025-09-15 | 1.8 | Status updated to Ready for Development - Product Owner Master Checklist completed with 95% confidence, all critical issues resolved | Sarah (Product Owner) |
| 2025-09-16 | 1.9 | **STORY COMPLETE** - All functionality implemented, QA gate PASSED, image preview sizing fixed, layout positioning corrected | Sarah (Product Owner) |

## Story Hygiene
- 1.0 owns project config & scaffolds only
- 1.1+ own functional behavior
- If a task exists in a prior story, reference it as "Inherited" and don't restate it